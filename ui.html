<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>A11y Annotator</title>
    <style>
      body { font: 12px -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 12px; }
      .row { margin-bottom: 8px; }
      button { padding: 6px 10px; }
      pre { background: #f6f6f6; padding: 8px; border-radius: 4px; white-space: pre-wrap; word-break: break-word; }
    </style>
  </head>
  <body>
    <div class="row">
      <label><input type="radio" name="platform" value="rn" checked /> React Native</label>
      <label style="margin-left:12px;"><input type="radio" name="platform" value="web" /> Web (ARIA)</label>
    </div>
    <div class="row">
      <button id="proposeBtn">Propose Focus Order</button>
      <div id="status" style="margin-top:8px; font:12px/1.3 Inter, system-ui; color:#555;"></div>
    </div>
    <div class="row"><textarea id="textPrompt" placeholder="ARIA prompt for web platform..." style="width:100%; height:60px;"></textarea></div>
    <div class="row"><pre id="output"></pre></div>

    <script>
      function setStatus(s, isError) {
        var el = document.getElementById('status');
        if (!el) return;
        el.textContent = s;
        el.style.color = isError ? '#b00020' : '#222';
      }

      function getSelectedPlatform() {
        var r = document.querySelector('input[name="platform"]:checked');
        return (r && r.value) || 'web';
      }
      function getTextPrompt() {
        var t = document.getElementById('textPrompt');
        return (t && t.value) || '';
      }

      document.getElementById('proposeBtn').onclick = function () {
        setStatus('Sendingâ€¦');
        var platform = getSelectedPlatform();
        var textPrompt = getTextPrompt();
        console.log('[UI] Sent PROPOSE_FOCUS_ORDER', {platform, prompt: textPrompt});
        parent.postMessage({ 
          pluginMessage: { 
            type: 'PROPOSE_FOCUS_ORDER', 
            platform: platform, 
            prompt: textPrompt 
          } 
        }, '*');
      };

      const statusEl = document.getElementById('status');

      window.onmessage = (event) => {
        const msg = event.data.pluginMessage;
        if (!msg) return;

        if (msg.type === 'RESULT') {
          const { ok, annotations = [] } = msg.payload || {};
          const summary = annotations.map(a => {
            const id = a.frameId || a.frameID || a.id || '?';
            const n = Array.isArray(a.order) ? a.order.length : 0;
            return `Frame ${id}: ${n} items`;
          }).join(' ');
          if (statusEl) statusEl.textContent = ok
            ? `Annotation applied ${summary}`
            : `Server returned not-ok.`;
        }

        if (msg.type === 'ANNOTATION_APPLIED') {
          const { annotations = [], checksum } = msg.data || {};
          const annotation = annotations && annotations[0] ? annotations[0] : null;
          const itemCount = annotation && annotation.order ? annotation.order.length : 0;
          if (statusEl) statusEl.textContent = `Focus order applied: ${itemCount} items (checksum: ${(checksum && checksum.substring) ? checksum.substring(0, 8) : 'unknown'})`;
        }

        if (msg.type === 'ERROR') {
          if (statusEl) statusEl.textContent = `Error: ${msg.error || 'unknown'}`;
        }
      };
    </script>
  </body>
</html>